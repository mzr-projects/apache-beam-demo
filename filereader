@Bean
@StepScope
public MultiResourceItemReader<BufferedImage> imageReader(
        @Value("#{stepExecutionContext['baseDir']}") String baseDir) throws IOException {

    Path imageRoot = Paths.get(baseDir)
        .resolve("**/images"); // logical path, not glob

    List<Resource> resources;

    try (Stream<Path> stream = Files.walk(Paths.get(baseDir))) {
        resources = stream
            .filter(p -> p.getFileName().toString().equals("images"))
            .flatMap(imgDir -> {
                try {
                    return Files.list(imgDir);
                } catch (IOException e) {
                    return Stream.empty();
                }
            })
            .filter(p -> p.toString().endsWith(".jpg"))
            .map(p -> new FileSystemResource(p.toFile()))
            .toList();
    }

    MultiResourceItemReader<BufferedImage> reader = new MultiResourceItemReader<>();
    reader.setResources(resources.toArray(Resource[]::new));
    reader.setDelegate(new ImageItemReader());
    return reader;
}





@StepScope
public class StreamingImageReader implements ItemReader<Path> {

    private final Iterator<Path> iterator;

    public StreamingImageReader(
        @Value("#{stepExecutionContext['baseDir']}") String baseDir) throws IOException {

        this.iterator = Files.walk(Paths.get(baseDir))
            .filter(p -> p.toString().endsWith(".jpg"))
            .iterator();
    }

    @Override
    public Path read() {
        return iterator.hasNext() ? iterator.next() : null;
    }
}