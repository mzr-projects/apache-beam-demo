import org.springframework.batch.core.launch.JobOperator;
import org.springframework.batch.core.launch.support.SimpleJobOperator;
import org.springframework.batch.core.repository.JobRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.task.SyncTaskExecutor;
import org.springframework.transaction.PlatformTransactionManager;

@Configuration
public class BatchConfiguration {

    @Autowired
    private JobLauncher jobLauncher;

    @Autowired
    private JobRepository jobRepository;

    @Autowired
    private JobExplorer jobExplorer;

    @Autowired
    private PlatformTransactionManager transactionManager;

    @Bean
    public JobOperator jobOperator() {
        SimpleJobOperator jobOperator = new SimpleJobOperator();
        jobOperator.setJobLauncher(jobLauncher);
        jobOperator.setJobRepository(jobRepository);
        jobOperator.setJobExplorer(jobExplorer);
        jobOperator.setTransactionManager(transactionManager);
        // Optional: for concurrent launches; SyncTaskExecutor is safe for simple cases
        jobOperator.setTaskExecutor(new SyncTaskExecutor());
        return jobOperator;
    }
}





import org.springframework.batch.core.*;
import org.springframework.batch.core.explore.JobExplorer;
import org.springframework.batch.core.launch.JobOperator;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.util.Comparator;
import java.util.List;

@Component
public class JobRestartService {

    @Autowired
    private JobOperator jobOperator;

    @Autowired
    private JobExplorer jobExplorer;

    @Autowired
    private Job job;  // Your job bean, e.g., imageToKafkaJob

    private static final String JOB_NAME = "imageToKafkaJob";  // Replace with your job name

    /**
     * Restarts the most recent FAILED JobExecution for the job.
     */
    public Long restartLastFailedJob() throws Exception {
        // Get the latest JobInstance (by start time descending)
        List<JobInstance> jobInstances = jobExplorer.getJobInstances(JOB_NAME, 0, 100);  // Adjust count if many instances
        if (jobInstances.isEmpty()) {
            System.out.println("No job instances found for " + JOB_NAME);
            return null;
        }

        // Find the most recent FAILED execution
        JobExecution failedExecution = jobInstances.stream()
                .flatMap(instance -> jobExplorer.getJobExecutions(instance).stream())
                .filter(exec -> exec.getStatus() == BatchStatus.FAILED || exec.getStatus() == BatchStatus.STOPPED)
                .max(Comparator.comparing(JobExecution::getStartTime))
                .orElse(null);

        if (failedExecution == null) {
            System.out.println("No failed executions found. Launch a new job instead.");
            return launchNewJob();  // Optional: fallback to new launch
        }

        System.out.println("Restarting failed JobExecution ID: " + failedExecution.getId());
        return jobOperator.restart(failedExecution.getId());
    }

    /**
     * Optional: Restart by specific execution ID (e.g., from logs or DB query)
     */
    public Long restartByExecutionId(Long executionId) throws Exception {
        JobExecution execution = jobExplorer.getJobExecution(executionId);
        if (execution == null || !execution.getStatus().isUnsuccessful()) {
            System.out.println("Execution ID " + executionId + " not found or not failed.");
            return null;
        }
        System.out.println("Restarting JobExecution ID: " + executionId);
        return jobOperator.restart(executionId);
    }

    /**
     * Fallback: Launch a completely new job instance (if no failed one)
     */
    private Long launchNewJob() throws Exception {
        JobParameters params = new JobParametersBuilder()
                .addString("inputDir", "/path/to/images")  // Use your fixed parameters
                .toJobParameters();
        JobExecution execution = jobLauncher.run(job, params);
        return execution.getId();
    }
}


@SpringBootApplication
@EnableBatchProcessing
public class Application implements CommandLineRunner {

    @Autowired
    private JobRestartService restartService;

    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }

    @Override
    public void run(String... args) throws Exception {
        if (args.length > 0 && "restart".equals(args[0])) {
            restartService.restartLastFailedJob();
        }
    }
}